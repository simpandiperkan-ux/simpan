<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>QR Stiker SIMPAN</title>

<style>
/* ================= GLOBAL ================= */
body{
  margin:0;
  padding:18px;
  background:#f2f2f2;
  font-family:Arial, Helvetica, sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* ================= TOMBOL ================= */
.actions{ margin-bottom:14px; }
.actions button{
  padding:9px 16px;
  margin:4px;
  border:none;
  background:#0a4ea3;
  color:#fff;
  font-weight:bold;
  border-radius:6px;
  cursor:pointer;
}

/* ================= STIKER ================= */
.sticker{
  width:8cm;
  height:10cm;
  background:#fff;
  border:3px solid #000;
  box-sizing:border-box;
  padding:10px 12px;
  text-align:center;
  position:relative;
}

/* ================= HEADER ================= */
.logo{
  width:64px;
  margin-bottom:4px;
}
.header{
  font-size:11.5px;
  font-weight:bold;
  line-height:1.25;
  margin-bottom:4px;
}

/* ================= QR ================= */
.qr-wrap{
  position:relative;
  width:160px;
  height:160px;
  margin:8px auto 6px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fff;
}

.qr-wrap img{
  width:140px;
  height:140px;
  background:#fff;
  padding:6px;
  box-sizing:border-box;
  z-index:2;
}

/* ===== WATERMARK SIMPAN (PASTI MUNCUL) ===== */
.watermark{
  position:absolute;
  inset:0;
  background:
    url("logo-simpan.png") center/80% no-repeat,
    repeating-linear-gradient(
      -45deg,
      rgba(10,78,163,0.06) 0,
      rgba(10,78,163,0.06) 90px,
      rgba(10,78,163,0.1) 180px
    );
  opacity:0.4;
  z-index:1;
  pointer-events:none;
}

/* ================= TEKS ================= */
.id{
  font-size:12px;
  font-weight:bold;
  margin-top:4px;
}
.info{
  font-size:11.5px;
  margin-top:1px;
}
.note{
  margin-top:6px;
  font-weight:bold;
  font-size:12px;
}

/* ================= FOOTER ================= */
.footer{
  position:absolute;
  bottom:6px;
  left:0;
  width:100%;
  text-align:center;
  font-size:9px;
  color:#555;
}
</style>
</head>

<body>

<div class="actions">
  <button>Download PNG</button>
  <button>Download JPG</button>
  <button>Download PDF</button>
</div>

<div class="sticker">

  <img src="logo-bateng.png" class="logo" alt="Logo Bateng">

  <div class="header">
    DINAS PERIKANAN<br>
    KABUPATEN BANGKA TENGAH
  </div>

  <div class="qr-wrap">
    <div class="watermark"></div>
    <img id="qrImg" alt="QR SIMPAN">
  </div>

  <div id="idText" class="id">-</div>
  <div id="namaText" class="info">NAMA : -</div>
  <div id="kapalText" class="info">KAPAL : -</div>

  <div class="note">SCAN UNTUK VERIFIKASI</div>

  <!-- TANGGAL CETAK PALING BAWAH TENGAH -->
  <div id="footerCetak" class="footer"></div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const SHEET_JSON =
  "https://docs.google.com/spreadsheets/d/1G8fNMGPKo3QX8rm85ux8u8SC0m3SpwKMtzXWShOscZQ/gviz/tq?tqx=out:json";

  const DETAIL_URL =
  "https://simpandiperkan-ux.github.io/simpan/kapal.html?id=";

  const up = v => String(v || "").toUpperCase().trim();

  const idCari = new URLSearchParams(location.search).get("id");

  const qrImg   = document.getElementById("qrImg");
  const idEl    = document.getElementById("idText");
  const namaEl  = document.getElementById("namaText");
  const kapalEl = document.getElementById("kapalText");
  const footer  = document.getElementById("footerCetak");

  idEl.textContent = idCari ? up(idCari) : "ID SIMPAN TIDAK DITEMUKAN";
  footer.textContent = "Dicetak: " + new Date().toLocaleDateString("id-ID");

  namaEl.textContent  = "NAMA : -";
  kapalEl.textContent = "KAPAL : -";

  if (!idCari) return;

  qrImg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=600x600&margin=0&data=" +
    encodeURIComponent(DETAIL_URL + idCari);

  fetch(SHEET_JSON)
    .then(r => r.text())
    .then(t => {
      const json = JSON.parse(t.substring(47, t.length - 2));
      const headers = json.table.cols.map(c => c.label);
      const rows = json.table.rows.map(r =>
        r.c.map(c => (c && c.v !== null ? c.v : ""))
      );

      const idxID    = headers.indexOf("ID SIMPAN");
      const idxNama  = headers.indexOf("Nama Pemilik Kapal (Sesuai KTP)");
      const idxKapal = headers.indexOf("Nama Kapal");

      if (idxID === -1 || idxNama === -1 || idxKapal === -1) {
        namaEl.textContent = "NAMA : KOLOM TIDAK SESUAI";
        return;
      }

      const row = rows.find(r => up(r[idxID]) === up(idCari));
      if (!row) {
        namaEl.textContent = "NAMA : DATA TIDAK DITEMUKAN";
        return;
      }

      namaEl.textContent  = "NAMA : "  + up(row[idxNama]);
      kapalEl.textContent = "KAPAL : " + up(row[idxKapal]);
    })
    .catch(() => {
      namaEl.textContent = "NAMA : GAGAL MEMUAT DATA";
    });

});
</script>

</body>
</html>
