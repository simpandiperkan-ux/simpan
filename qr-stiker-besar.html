<script>
/* ===== PARAM URL ===== */
const params = new URLSearchParams(location.search);
const id = params.get("id");

if (!id) {
  alert("ID SIMPAN tidak ditemukan");
  throw "";
}

document.getElementById("idText").innerText = id;

/* ===== LOAD DATA CSV OTOMATIS ===== */
fetch("DATA_KAPAL.csv")
  .then(res => res.text())
  .then(text => {
    const rows = text.trim().split("\n");
    const headers = rows[0].split(",");

    const idxId    = headers.indexOf("id");
    const idxNama  = headers.indexOf("nama");
    const idxKapal = headers.indexOf("kapal");

    for (let i = 1; i < rows.length; i++) {
      const cols = rows[i].split(",");

      if (cols[idxId] === id) {
        document.getElementById("namaText").innerText =
          "Nama : " + cols[idxNama];

        document.getElementById("kapalText").innerText =
          "Kapal : " + cols[idxKapal];
        break;
      }
    }
  })
  .catch(err => {
    console.error("Gagal baca CSV", err);
  });

/* ===== QR CODE ===== */
const targetURL =
  "https://simpandiperkan-ux.github.io/simpan/kapal.html?id=" + encodeURIComponent(id);

document.getElementById("qrImg").src =
  "https://api.qrserver.com/v1/create-qr-code/?size=1200x1200&margin=0&data=" +
  encodeURIComponent(targetURL);

/* ===== CAPTURE ===== */
function captureCanvas(){
  return html2canvas(document.getElementById("capture"), {
    scale:3,
    useCORS:true
  });
}

/* ===== DOWNLOAD ===== */
function downloadPNG(){
  captureCanvas().then(c=>{
    const a=document.createElement("a");
    a.href=c.toDataURL("image/png");
    a.download="QR-"+id+".png";
    a.click();
  });
}

function downloadJPG(){
  captureCanvas().then(c=>{
    const a=document.createElement("a");
    a.href=c.toDataURL("image/jpeg",0.95);
    a.download="QR-"+id+".jpg";
    a.click();
  });
}

async function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const c = await captureCanvas();
  const pdf = new jsPDF({
    orientation:"portrait",
    unit:"cm",
    format:[8,10]
  });
  pdf.addImage(c.toDataURL("image/png"),"PNG",0,0,8,10);
  pdf.save("QR-"+id+".pdf");
}
</script>
