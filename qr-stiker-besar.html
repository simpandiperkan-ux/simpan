<script>
/* ===============================
   SUMBER DATA (GOOGLE SHEET)
================================ */
const SHEET_JSON =
"https://docs.google.com/spreadsheets/d/1G8fNMGPKo3QX8rm85ux8u8SC0m3SpwKMtzXWShOscZQ/gviz/tq?tqx=out:json";

/* ===============================
   AMBIL ID DARI URL
================================ */
const idCari = new URLSearchParams(location.search).get("id");

/* ===============================
   AMBIL ELEMEN HTML
================================ */
const idEl    = document.getElementById("idText");
const namaEl  = document.getElementById("namaText");
const kapalEl = document.getElementById("kapalText");
const qrImg   = document.getElementById("qrImg");

/* ===============================
   TAMPILKAN ID
================================ */
if (idEl) {
  idEl.innerText = idCari ? idCari : "ID SIMPAN tidak ditemukan";
}

/* ===============================
   QR CODE (SELALU JALAN)
================================ */
if (qrImg && idCari) {
  const targetURL =
    "https://simpandiperkan-ux.github.io/simpan/kapal.html?id=" +
    encodeURIComponent(idCari);

  qrImg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=1200x1200&margin=0&data=" +
    encodeURIComponent(targetURL);
}

/* ===============================
   AMBIL DATA DARI SHEET
================================ */
if (idCari) {
  fetch(SHEET_JSON)
    .then(r => r.text())
    .then(t => {
      const j = JSON.parse(t.substring(47, t.length - 2));
      const headers = j.table.cols.map(c => c.label);
      const rows = j.table.rows.map(r => r.c.map(c => c?.v ?? ""));

      const idxID    = headers.indexOf("ID SIMPAN");
      const idxNama  = headers.indexOf("Nama Lengkap");
      const idxKapal = headers.indexOf("Nama Kapal");

      if (idxID === -1) {
        if (namaEl) namaEl.innerText = "Kolom ID SIMPAN tidak ditemukan";
        return;
      }

      const row = rows.find(r =>
        r[idxID]?.toString().trim() === idCari
      );

      if (!row) {
        if (namaEl) namaEl.innerText = "Data tidak ditemukan";
        return;
      }

      if (namaEl) {
        namaEl.innerText = "Nama : " + (row[idxNama] || "-");
      }

      if (kapalEl) {
        kapalEl.innerText = "Kapal : " + (row[idxKapal] || "-");
      }
    })
    .catch(() => {
      if (namaEl) namaEl.innerText = "Gagal memuat data";
    });
}
</script>
