<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>QR Stiker SIMPAN</title>

<style>
/* ================= RESET ================= */
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#f2f2f2;
  font-family:Arial, Helvetica, sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* ================= BUTTON ================= */
.actions{
  margin:18px;
}
.actions button{
  padding:9px 16px;
  margin:4px;
  border:none;
  background:#0a4ea3;
  color:#fff;
  font-weight:bold;
  border-radius:5px;
  cursor:pointer;
}

/* ================= STIKER ================= */
.sticker{
  width:8cm;
  height:12cm;
  background:#fff;
  border:3px solid #000;
  position:relative;
  overflow:hidden;
  text-align:center;
  padding:10px 8px;
}

/* ===== WATERMARK SIMPAN (FINAL) ===== */
.sticker::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:url("./logo-simpan.png");
  background-repeat:repeat;
  background-size:140px auto;
  background-position:center;
  opacity:0.18;           /* TERANG & AMAN */
  pointer-events:none;
  z-index:0;
}
.sticker > *{
  position:relative;
  z-index:1;
}

/* ================= HEADER ================= */
.logo-bateng{
  width:62px;
  margin:2px auto 4px;
}
.title{
  font-size:11.5px;
  font-weight:bold;
  line-height:1.25;
  margin-bottom:6px;
}

/* ================= QR ================= */
.qr-box{
  margin:6px auto 4px;
}
.qr-box img{
  width:230px;
  height:230px;
}

/* ================= DATA ================= */
.id{
  font-size:13px;
  font-weight:bold;
  margin-top:4px;
}
.info{
  font-size:11.5px;
  margin-top:2px;
}

/* ================= FOOTER ================= */
.note{
  font-size:12px;
  font-weight:bold;
  margin-top:6px;
}
.footer{
  font-size:9px;
  margin-top:3px;
}
</style>
</head>

<body>

<div class="actions">
  <button onclick="downloadPNG()">Download PNG</button>
  <button onclick="downloadJPG()">Download JPG</button>
  <button onclick="downloadPDF()">Download PDF</button>
</div>

<div class="sticker" id="areaCetak">
  <img src="./logo-bateng.png" class="logo-bateng">
  <div class="title">
    DINAS PERIKANAN<br>
    KABUPATEN BANGKA TENGAH
  </div>

  <div class="qr-box">
    <img id="qrImg">
  </div>

  <div id="idText" class="id"></div>
  <div id="namaText" class="info"></div>
  <div id="kapalText" class="info"></div>

  <div class="note">SCAN UNTUK VERIFIKASI</div>
  <div id="footerCetak" class="footer"></div>
</div>

<script>
/* ================= KONFIG RESMI ================= */
const SHEET_JSON =
"https://docs.google.com/spreadsheets/d/1G8fNMGPKo3QX8rm85ux8u8SC0m3SpwKMtzXWShOscZQ/gviz/tq?tqx=out:json";
const DETAIL_URL =
"https://simpandiperkan-ux.github.io/simpan/kapal.html?id=";

/* ================= UTIL ================= */
const up = v => String(v||"").toUpperCase().trim();

/* ================= PARAM ================= */
const idCari = new URLSearchParams(location.search).get("id");

/* ================= DOM ================= */
const qrImg  = document.getElementById("qrImg");
const idEl   = document.getElementById("idText");
const namaEl = document.getElementById("namaText");
const kapalEl= document.getElementById("kapalText");
const footer = document.getElementById("footerCetak");

/* ================= DEFAULT ================= */
idEl.innerText = idCari ? up(idCari) : "ID SIMPAN TIDAK DITEMUKAN";
footer.innerText =
"Tanggal Cetak : " + new Date().toLocaleDateString("id-ID");

/* ================= QR ================= */
if(!idCari){
  namaEl.innerText="NAMA : -";
  kapalEl.innerText="KAPAL : -";
}else{
  qrImg.src =
  "https://api.qrserver.com/v1/create-qr-code/?size=600x600&margin=0&data=" +
  encodeURIComponent(DETAIL_URL + idCari);
}

/* ================= DATA SHEET ================= */
if(idCari){
fetch(SHEET_JSON)
.then(r=>r.text())
.then(t=>{
  const j=JSON.parse(t.substring(47,t.length-2));
  const h=j.table.cols.map(c=>c.label);
  const rows=j.table.rows.map(r=>r.c.map(c=>c?.v??""));

  const idxID    = h.indexOf("ID SIMPAN");
  const idxNama  = h.indexOf("Nama Pemilik Kapal (Sesuai KTP)");
  const idxKapal = h.indexOf("Nama Kapal");

  if(idxID<0||idxNama<0||idxKapal<0){
    namaEl.innerText="NAMA : KOLOM TIDAK DITEMUKAN";
    kapalEl.innerText="KAPAL : -";
    return;
  }

  const row = rows.find(r=>up(r[idxID])===up(idCari));
  if(!row){
    namaEl.innerText="NAMA : DATA TIDAK DITEMUKAN";
    kapalEl.innerText="KAPAL : -";
    return;
  }

  namaEl.innerText ="NAMA : "+up(row[idxNama]);
  kapalEl.innerText="KAPAL : "+up(row[idxKapal]);
})
.catch(()=>{
  namaEl.innerText="NAMA : GAGAL MEMUAT DATA";
  kapalEl.innerText="KAPAL : -";
});
}

/* ================= DOWNLOAD ================= */
function downloadPNG(){alert("Aktifkan library html2canvas bila diperlukan");}
function downloadJPG(){alert("Aktifkan library html2canvas bila diperlukan");}
function downloadPDF(){alert("Aktifkan library jsPDF bila diperlukan");}
</script>

</body>
</html>
